---
title: "SpatioTemporal Model for Abundance Prediction"
header-includes:
   - \usepackage{bm} 
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Basic Idea

Suppose that we would like to predict animal abundance from surveys in multiple years. We expect that observations will be correlated across both space and time. First, let's assume that we have a separable model, no covariates for predicting abundance, and that we have perfect detection in our surveys of sampled sites. Let $Y(\mathbf{s}_{ij}, \mathbf{t}_j)$, $i = 1 \ldots n_{sp}$ and $j = 1 \ldots n_{t}$ be a latent, unobserved spatiotemporal surface with $n_{sp}$ as the number of spatial sites and $n_t$ as the number of time points. The underlying spatio-temporal surface is

\begin{equation}
Y(\mathbf{s}_{ij}, \mathbf{t}_j) = \bm{\beta}_0 + \bm{\epsilon}(\mathbf{s}_{ij}, \mathbf{t}_j),
\end{equation}

where $\mathbf{s}_{ij}$ references the $i^{th}$ spatial location at tike $j$, $\mathbf{t}_j$ references the $j^{th}$ time point, and $\beta_0$ is the overall mean. Then, we assume the errors $\bm{\epsilon}$ have mean $\mathbf{0}$ and covariance

<!-- and spatiotemporal covariance matrix $\bm{\Sigma}$ with element $i, j$ of $\bm{\Sigma}$ as -->

\begin{equation}
\label{equation:covariancemat}
\bm{\Sigma}_{n_{sp}(j - 1) + i, n_{sp}(j' - 1) + i'} = \sigma^2 \rho_1 (\vert\vert \mathbf{s}_i - \mathbf{s}_{i'} \vert \vert) \rho_2 (\vert\vert \mathbf{t}_j - \mathbf{t}_{j'} \vert \vert). 
\end{equation}

at spatial location $i$ and time point $j$. __Note__: this took me a while to think through the indexing and it's still quite clumsy.

At first, let's assume an exponential covariance structure for the spatial model and an AR(1) model for the time series model.

\begin{equation}
\rho_1 (\vert\vert \mathbf{s}_i - \mathbf{s}_{i'} \vert \vert) = \text{exp}(-h_{ii'} / \phi),
\end{equation}

where $h_{ii'}$ is the Euclidean distance between locations $\mathbf{s}_i$ and $\mathbf{s}_{i'}$ and $\phi$ is the range parameter.

Also,

\begin{equation}
\rho_2 (\vert\vert \mathbf{t}_j - \mathbf{t}_{j'} \vert \vert) = \psi^{k_{jj'}},
\end{equation}

where $k_{jj'}$ is the number of time points between $j$ and $j'$ and $\psi$ is the autocorrelation parameter. For surveys done yearly, $j$ indexes the year, assuming that we have a survey every year and equally spaced time points.

Then, let $\bm{\Sigma}$ (\ref{equation:covariancemat}) be the spatiotemporal covariance matrix.

$Z(\mathbf{s}_{ij}, \mathbf{t}_j)$, $i = 1 \ldots n_{sp}$ and $j = 1 \ldots n_{t}$ is our observed animal count at spatial location $i$ and time point $j$. Then, give $Z(\mathbf{s}_{ij}, \mathbf{t}_j)$ the following conditional moments:

$$
\text{E}(Z(\mathbf{s}_{ij}, \mathbf{t}_j) \vert Y(\mathbf{s}_{ij}, \mathbf{t}_j)) = Y(\mathbf{s}_{ij}, \mathbf{t}_j)
$$
and

$$
\text{var}(Z(\mathbf{s}_{ij}, \mathbf{t}_j) \vert Y(\mathbf{s}_{ij}, \mathbf{t}_j)) = \tau^2,
$$

where $\tau^2$ is a nugget effect. We also assume that $Z(\mathbf{s}_{ij}, \mathbf{t}_j) \vert Y(\mathbf{s}_{ij}, \mathbf{t}_j)$ is independent of all  $Z(\mathbf{s}_{i'j'}, \mathbf{t}_{j'}) \vert Y(\mathbf{s}_{i'j'}, \mathbf{t}_{j'})$ as long as $i \neq i'$ or $j \neq j'$. 

Using laws of conditional expectation and conditional covariance,

$$
\text{E}(Z(\mathbf{s}_{ij}, \mathbf{t}_j)) = \mathbf{\beta}_0
$$

and 

$$
\text{cov}(Z(\mathbf{s}_{ij}, \mathbf{t}_j), Z(\mathbf{s}_{i'j'}, \mathbf{t}_{j'})) = (\bm{\Sigma} + \text{diag}(\tau^2))_{n_{sp}(j - 1) + i, n_{sp}(j' - 1) + i'}
$$

## Bringing in the Unsampled Sites

Reference:

<http://faculty.missouri.edu/~wiklec/ST_3_wikle_Boston_Descriptive.pdf>

Resume with $D$ matrix and some of the equations involving unsampled sites of the current year.

Reorder the rows so that it's unsampled past, sampled past, unsampled present, sampled present. Can pretty much ignore the rows that were unsampled past.

## The Model


First, our prediction for the sampled (observed) sites is simply what we observed:

$$
\hat{z}_s = z_s,
$$

where $s$ denotes a site that was sampled.

Our predictions for the unsampled sites come from the usual block kriging formulae:

$$
\mathbf{\hat{z}}_{ucurr} = \bm{\Sigma}_{ucurr,s} \bm{\Sigma}_{ss}^{-1}(\mathbf{z}_s - \bm{\hat{\mu}}_s) + \bm{\hat{\mu}}_{ucurr},
$$


where $\bm{\Sigma}_{us}$ denotes the matrix of covariances between unsampled sites and sampled sites, $\bm{\Sigma}_{ss}$ denotes the covariance matrix of the sampled sites only, $\bm{\hat{\mu}}_s = \mathbf{X}_s \bm{\hat{\beta}}_{GLS}$, $\bm{\hat{\mu}}_u = \mathbf{X}_u \bm{\hat{\beta}}_{GLS}$, and $\bm{\hat{\beta}}_{GLS}$ is the usual generalized least squares estimator. 


#####Unbiasedness Condition

The linear model for $\mathbf{z}$ is 

$$
\mathbf{z} = \mathbf{X} \bm{\beta} + \bm{\delta},
$$

denoting $\mathbf{X} \bm{\beta} = \bm{\mu}$ as the mean and $\bm{\delta}$ as the error with spatio-temporal covariance structure. Then, we want the prediction weights to be uniformly unbiased:

\begin{align*}
E(\mathbf{a}'\mathbf{z}_s) &= E(\mathbf{b}'\mathbf{z}_{curr}) \forall \bm{\beta} \\
\leftrightarrow \mathbf{a}'\mathbf{X}_s &= \mathbf{b}_{curr}'\mathbf{X}_{curr}\\ \leftrightarrow \mathbf{a}'\mathbf{X}_s &= \mathbf{b}_{scurr}'\mathbf{X}_{scurr} + \mathbf{b}_{ucurr}'\mathbf{X}_{ucurr},
\end{align*}

where $scurr$ denotes only sampled sites in the current year, $ucurr$ denotes only unsampled sites in the current year, and $s$ denotes all sampled sites (current year and past years).

Then, the "kriging" equations are:

$$
\begin{pmatrix}
\bm{\Sigma}_{ss} & \mathbf{X}_s \\
\mathbf{X}_s' & 0
\end{pmatrix} 
\begin{pmatrix}
\bm{\lambda} \\
m
\end{pmatrix} = 
\begin{pmatrix}
\bm{\Sigma}_{s, s} & \bm{\Sigma}_{s, ucurr} \\
\mathbf{X}_{s}' & \mathbf{X}_{ucurr}'
\end{pmatrix} 
\begin{pmatrix}
\mathbf{b}_{s} \\
\mathbf{b}_{ucurr}
\end{pmatrix},
$$

where $s$ denotes the sampled sites (past and present), $scurr$ denotes the current sampled sites, and $ucurr$ denotes the current unsampled sites. $\bm{\lambda}$ is an $n$ by 1 vector, where $n$ denotes the number of sampled sites (both past and present). The vector $\mathbf{b}_{s}$ is a vector of 1's and 0's, with 1's for the sampled sites in the current year and 0's for the sampled sites in the past.

Then, we can solve for the prediction weights as

$$
\bm{\lambda}_s = \mathbf{b}_{s}' + \mathbf{b}_{ucurr}' (\bm{\Sigma}_{ucurr, s}\bm{\Sigma}_{ss}^{-1}) - \mathbf{b}'_{ucurr}(\bm{\Sigma}_{ucurr, s} \bm{\Sigma}_{ss}^{-1})\mathbf{X}_s(\mathbf{X}_s'\bm{\Sigma}_{ss}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s'\bm{\Sigma}_{ss}^{-1} + \mathbf{b}_{ucurr}' \mathbf{X}_{ucurr}'(\mathbf{X}_s'\bm{\Sigma}_{ss}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s \bm{\Sigma}_{ss}^{-1}.
$$

Our prediction is then:

$$
\bm{\lambda}_s' \mathbf{z}_s,
$$

which is equivalent to 

$$
\mathbf{b}_{scurr}'\mathbf{z}_{scurr} + \mathbf{b}_{ucurr}' \mathbf{\hat{z}}_{ucurr},
$$

where $\mathbf{\hat{z}}_{ucurr} = \bm{\Sigma}_{ucurr, s} \Sigma_{ss}^{-1} (\mathbf{z}_s - \bm{\hat{\mu}}_s) + \bm{\hat{\mu}}_u$ with $\bm{\hat{\mu}}_s = \mathbf{X}_s \bm{\hat{\beta}}_{GLS}, \bm{\hat{\mu}}_u = \mathbf{X}_u \bm{\hat{\beta}}_{GLS}$. $\bm{\hat{\beta}}_{GLS}$ is the generalized least squares estimator $(\mathbf{X}_s' \bm{\Sigma}_{ss}^{-1} \mathbf{X}_s)^{-1} \mathbf{X}_s' \bm{\Sigma}_{ss}^{-1} \mathbf{z}_s$.

Our prediction has a prediction variance that can be found as

$$
E((\bm{\lambda}_s'\mathbf{z}_s - \mathbf{b}_{curr}'\mathbf{z}_{curr})(\bm{\lambda}_s'\mathbf{z}_s - \mathbf{b}'\mathbf{z}_{curr})) =
$$

$$
\bm{\lambda}'\bm{\Sigma}_{ss}\bm{\lambda} - 2 \mathbf{b}'_{c} \bm{\Sigma}_{cs} \bm{\lambda} + \mathbf{b}'_{c} \bm{\Sigma}_{cc}\mathbf{b}_c,
$$

where $c$ denotes the current year (both past and present) and $\bm{\Sigma}_{cs}$ denotes the covariance matrix of all of the current spatial sites with the sites that were sampled.















