---
title: |
  An Application of Spatiotemporal Modeling to Finite Population Abundance Prediction
type: ARTICLE TEMPLATE
author:
  - name: Matt Higham
    affil: a
    email: mhigham@stlawu.edu
  - name: Carly Hammond, John Merickel, Jeff Wells
    affil: b
    email: fill these in later
  - name: add more
    affil: c, \dagger, \ddagger
    email: leutnant@fh-muenster.de
affiliation:
  - num: a
    address: |
      St. Lawrence University
      Canton, NY 13617
  - num: b
    address: |
      fill in later
  - num: c
    address: |
      fill in later
bibliography: interactcadsample.bib
# appendix: appendix.tex
abstract: |
  Insert abstract here.
keywords: |
  spatial; temporal; kriging; 
header-includes: |
  \usepackage{hyperref}
  \usepackage[utf8]{inputenc}
  \def\tightlist{}
output: rticles::tf_article
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

\section{Introduction}

\subsection{Motivation}

Moose surveys in Alaska and western Canada are often performed annually in many regions. The primary goal of these surveys is to predict moose abundance, the total number of moose, in the region. Because of time and money constraints, only some areas (sites) in the region of interest are selected to be in the survey. Biologists fly to these selected sites, count the number of moose, and can then use a spatial statistical model to find a prediction for the finite abundance for that year [@ver2008spatial]. 

Though these surveys are annual, each survey is analysed completely independently of surveys from previous years [e.g. @gasaway1986estimating; @kellie_geospatial_2006; @boertje2009managing; @peters2014contrasting]. For example, a model for a survey conducted in the year 2019 only uses counts on sites that were sampled in that year. However, using counts from previous years in a model that incorporates both spatial and temporal correlation (spatiotemporal) could result in a prediction for the realized total or mean that is more precise than predictions from a spatial model using only counts from the most recent survey year. 

Though the framework of the motivation is given with an example on moose surveys, this type of analysis could be useful for many examples involving prediction in a finite region with spatial sites that are surveyed regularly.

\subsection{Background}

* Add paragraph about background of spatiotemporal models

Prediction for a total, a subset of the total, or a mean in a finite number of spatial locations should incorporate a finite population correction to the variance of the predictor [@ver2008spatial; @higham2021adjusting]. In the context of ecological monitoring in spatiotemporal prediction, we are often most interested in predicting the total abundance for the most recent year of the survey. In this case, the finite population correction should adjust based on the number of sites surveyed in the current year of the survey, so that, for example, the prediction variance is zero if all sites in the current year are sampled.


The rest of this paper is organized as follows. In Section \ref{section:Methods}, we couple spatiotemporal modeling with finite population prediction to develop the Best-Linear-Unbiased-Predictor for any linear function of site abundance, including the total abundance across all sites. In Section \ref{section:Application}, we apply the predictor to a moose data set in the TOC region of Alaska. In Section \ref{section:Simulation}, we conduct a brief simulation study to examine the properties of the predictor. Finally, in Section \ref{section:Discussion}, we conclude and give directions for future research.

\section{Methods} \label{section:Methods}

We now give details on the development of the predictor for abundance. We first detail the spatiotemporal model, and we then use the spatiotemporal model with a finite population correction factor to give a Best-Linear-Unbiased-Predictor (BLUP) and its variance for total abundance in a given year.

\subsection{Spatiotemporal Model}

Let $Y(\mathbf{s}_{i}, t_j)$, $i = 1, 2, \ldots, n_{sp}$ and $j = 1, 2, \ldots, n_{t}$ be a random variable, where the vector $\mathbf{s}_i$ contains the coordinates for the $i^{th}$ spatial site location and where $t_j$ is the $j^{th}$ time point. With each spatial location at each time point, the total number of data points (observed and unobserved) is $n_{sp} \cdot n_{t} \equiv N$. Then, a model for $\mathbf{y}(\mathbf{s}_{i}, t_j)$, a vector of the $Y(\mathbf{s}_{i}, t_j)$, is

\begin{equation}
\mathbf{y}(\mathbf{s}_{i}, t_j) = \mathbf{X} \bm{\beta} + \bm{\epsilon}(\mathbf{s}_{i}, t_j),
\end{equation}
\noindent
where $\mathbf{X}$ is a design matrix for fixed effects and $\bm{\beta}$ is a parameter vector of fixed effects. The error $\bm{\epsilon}(\mathbf{s}_{i}, t_j)$ can be decomposed into spatial and temporal components, as in @dumelle2021linear. In particular, a sum-with-error linear mixed model for response vector $\mathbf{y}(\mathbf{s}_{i}, t_j)$ is

\begin{equation} \label{equation:model}
\mathbf{y}(\mathbf{s}_{i}, t_j) = \mathbf{X} \bm{\beta} + \mathbf{Z}_{sp} \bm{\delta} + \mathbf{Z}_{sp} \bm{\gamma} + \mathbf{Z}_t \bm{\tau} + \mathbf{Z}_t \bm{\eta} + \bm{\nu}.
\end{equation}

$\mathbf{Z}_{sp}$ is an $N \times n_{sp}$ matrix where the values in a row corresponding to an observation in location $\mathbf{s}_{i}$ are a $1$ in the $i^{th}$ column and 0's in all other columns. Similarly, $\mathbf{Z}_t$ is an $N \times n_{t}$ matrix where the values in a row corresponding to an observation at time point $\mathbf{t}_j$ are a $1$ in the $j^{th}$ column and 0's in all other columns. We assume that $\bm{\delta}$, $\bm{\gamma}$, $\bm{\tau}$, $\bm{\eta}$, and $\bm{\nu}$ all are all mean $\mathbf{0}$ vectors of length $n_{sp}$, $n_{sp}$, $n_t$, $n_t$, and $N$, respectively, with covariances
\mbox{}
\begin{align*}
cov(\bm{\delta}) &= \sigma^2_{\delta} \mathbf{R}_{sp} \\
cov(\bm{\gamma}) &= \sigma^2_{\gamma} \mathbf{I}_{sp} \\
cov(\bm{\tau}) &= \sigma^2_{\tau} \mathbf{R}_t \\
cov(\bm{\eta}) &= \sigma^2_{\eta} \mathbf{I}_t \\
cov(\bm{\nu}) &= \sigma^2_{\nu} \mathbf{I}_N,
\end{align*}
\noindent
where $\mathbf{R}_{sp}$ is a spatial correlation matrix, $\mathbf{R}_t$ is a temporal correlation matrix, $\sigma^2_{\delta}$ and $\sigma^2_{\gamma}$ are the spatial partial sill and spatial nugget, $\sigma^2_{\tau}$ and $\sigma^2_{\eta}$ are the temporal partial sill and temporal nugget, and $\sigma^2_{\nu}$ is the spatiotemporal independent error variance parameter.

If we assume that $\bm{\delta}$, $\bm{\gamma}$, $\bm{\tau}$, $\bm{\eta}$, and $\bm{\nu}$ are mutually independent of each other, then 

\begin{equation}
\label{equation:var}
var(\mathbf{y}) \equiv \bm{\Sigma} = \sigma^2_{\delta} \mathbf{Z}_{sp} \mathbf{R}_{sp} \mathbf{Z}_{sp}' + \sigma^2_{\gamma} \mathbf{Z}_{sp} \mathbf{I}_{sp} \mathbf{Z}_{sp}' + \sigma^2_{\tau} \mathbf{Z}_t \mathbf{R}_t \mathbf{Z}_t'+ \sigma^2_{\eta} \mathbf{Z}_t \mathbf{I}_t \mathbf{Z}_t' + \sigma^2_{\nu} \mathbf{I}_N.
\end{equation}

There are many common parameterizations of $\mathbf{R}_{sp}$, but one form is the exponential. For observations at locations $i$ and $i'$ at $h_{ii'}$ distance apart, row $i$ and column $i'$ of $\mathbf{R}_{sp}$ is equal to
\mbox{}
\begin{equation}
\text{exp}(-h_{ii'} / \phi),
\end{equation}
\noindent
where $\phi$ is the range parameter. 

There are also many common parameterizations of $\mathbf{R}_t$, but one form is the exponential, which is equivalent to an AR(1) process in time series if the time points are equally spaced and the correlation parameter is greater than zero. For observations at time points $j$ and $j'$ that are $m_{jj'}$ units apart, row $j$ and column $j'$ of $\mathbf{R}_{t}$ is equal to
\mbox{}
\begin{equation}
\text{exp}(-m_{jj'} / \rho),
\end{equation}
\noindent
where $\rho$ is the autocorrelation parameter.

If we assume that $\mathbf{y}$ is multivariate normal with mean $\mathbf{X} \bm{\beta} \equiv \bm{\mu}$ and variance $\bm{\Sigma}$ (Equation \ref{equation:var}), then all parameters can be estimated with Maximum Likelihood or Restricted Maximum Likelihood.

Note that we will explore other covariance structures, including an extension of the sum-with-error model and different spatial and temporal correlation structures.

\subsection{Finite Population Kriging}

The model in equation \ref{equation:model} is used for all $N$ observations at $n_{sp}$ sites and $n_t$ time points. But, we typically do not have the resources to sample every spatial site in every year.

Let the subscript $s$ denote observations that were sampled (both past and present), and let the subscript $u$ denote observations that were unsampled. Then, we can re-order the response vector so that
\mbox{}
\begin{equation}
\mathbf{y} = [\mathbf{y}_u', \mathbf{y}_s']'.
\end{equation}

Let $\mathbf{\tilde{y}} = [\mathbf{\tilde{y}}_u', \mathbf{\tilde{y}}_s']'$ denote the fixed, realized values of the response variable for one data-generating process. Our primary goal is to use the model developed in the previous section to predict values for $\mathbf{\tilde{y}}_{u}$ from the observed data in $\mathbf{\tilde{y}}_{s}$. That is, we want to find optimal weights $\mathbf{a}'$ to apply to the sampled data $\mathbf{a}' \mathbf{\tilde{y}}_s$, such that $\mathbf{a}' \mathbf{y}_s$ is the Best Linear Unbiased Predictor (BLUP) for $\mathbf{b}_a' \mathbf{y}_a$. If we are interested in the total abundance across all years, then $\mathbf{b}_a$ is a column vector of 1's. so that we are adding up all values of the response for a predictor of total abundance. 

Unbiasedness implies that $E(\mathbf{a'}\mathbf{y}_s) = E(\mathbf{b}_a'\mathbf{y}_a)$ for all $\bm{\beta}$. So, denoting $\mathbf{X}_s$ as the design matrix for sampled sites, $\mathbf{a'} \mathbf{X}_s \bm{\beta}$ = $\mathbf{b'} \mathbf{X} \bm{\beta}$ for every $\bm{\beta}$, implying that $\mathbf{a'} \mathbf{X}_s = \mathbf{b'}_a \mathbf{X}$.

The kriging weights are then found by finding $\bm{\lambda}_s$, an $n \times 1$ vector, such that
\mbox{}
\begin{equation}
E\{(\mathbf{a'}\mathbf{y}_s - \mathbf{b'}_a \mathbf{y}_a)(\mathbf{a'}\mathbf{y}_s - \mathbf{b'}_a \mathbf{z}_a)\} - E\{(\bm{\lambda'}_s\mathbf{y}_s - \mathbf{b'}_a \mathbf{z}_a)(\bm{\lambda}_s'\mathbf{y}_s - \mathbf{b'}_a \mathbf{z}_a)\}
\end{equation}
\noindent
is greater than 0 for all $\mathbf{a'}$. The prediction equations are

\begin{equation}
\begin{pmatrix}
\bm{\Sigma}_{s, s} & \mathbf{X}_s \\
\mathbf{X}_s' & 0
\end{pmatrix} 
\begin{pmatrix}
\bm{\lambda} \\
m
\end{pmatrix} = 
\begin{pmatrix}
\bm{\Sigma}_{s, s} & \bm{\Sigma}_{s, u} \\
\mathbf{X}_{s}' & \mathbf{X}_{u}'
\end{pmatrix} 
\begin{pmatrix}
\mathbf{b}_{s} \\
\mathbf{b}_{u}
\end{pmatrix},
\end{equation}
\noindent
where again the subscripts $s$ and $u$ denote sampled and unsampled observations. For example, letting $n$ denote the number of sampled observations, $\bm{\Sigma}_{s, s}$ denotes the $n \times n$ submatrix of $\bm{\Sigma}$ corresponding only to rows and columns of sampled observations and $\bm{\Sigma}_{u, s}$ denotes the $(N - n) \times n$ submatrix of $\bm{\Sigma}$ corresponding to rows of observations that were not sampled and columns of observations that were sampled. Then, $\bm{\lambda}_s$ is an $n \times 1$ vector. 

Then, we can solve for the prediction weights as
\mbox{}
\begin{equation}
\bm{\lambda}_s = \mathbf{b}_{s}' + \mathbf{b}_{u}' (\bm{\Sigma}_{u, s}\bm{\Sigma}_{s, s}^{-1}) - \mathbf{b}'_{u}(\bm{\Sigma}_{u, s} \bm{\Sigma}_{s, s}^{-1})\mathbf{X}_s(\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1} + \mathbf{b}_{u}' \mathbf{X}_{u}'(\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s \bm{\Sigma}_{s, s}^{-1}.
\end{equation}
\noindent
Our prediction for the total abundance across all years of the survey is then
\mbox{}
\begin{equation}
\bm{\lambda}_s' \mathbf{\tilde{y}}_s,
\end{equation}
\noindent
with a prediction variance of 
\mbox{}
\begin{equation}
E((\bm{\lambda}_s'\mathbf{y}_s - \mathbf{b}_a'\mathbf{y}_a)(\bm{\lambda}_s'\mathbf{y}_s - \mathbf{b}_a'\mathbf{y}_a)) = \\
\bm{\lambda}_s'\bm{\Sigma}_{s, s}\bm{\lambda}_s - 2 \mathbf{b}_a' \bm{\Sigma}_{a ,s} \bm{\lambda}_s + \mathbf{b}_a' \bm{\Sigma}\mathbf{b}_a.
\end{equation}



<!-- which is equivalent to  -->

<!-- $$ -->
<!-- \mathbf{b}_{s}'\mathbf{\tilde{y}}_{s} + \mathbf{b}_{u}' \mathbf{\hat{y}}_{u}, -->
<!-- $$ -->
<!-- where $\mathbf{\hat{y}}_{u} = \bm{\Sigma}_{u, s} \Sigma_{s, s}^{-1} (\mathbf{\tilde{y}}_s - \bm{\hat{\mu}}_s) + \bm{\hat{\mu}}_u$ with $\bm{\hat{\mu}}_s = \mathbf{X}_s \bm{\hat{\beta}}_{GLS}, \bm{\hat{\mu}}_u = \mathbf{X}_u \bm{\hat{\beta}}_{GLS}$. $\bm{\hat{\beta}}_{GLS}$ is the generalized least squares estimator $(\mathbf{X}_s' \bm{\Sigma}_{s, s}^{-1} \mathbf{X}_s)^{-1} \mathbf{X}_s' \bm{\Sigma}_{s, s}^{-1} \mathbf{y}_s$. -->



<!-- site-by-site predictions for the unsampled sites in both the past and the present come from the usual block kriging formulae: -->

<!-- \begin{equation} -->
<!-- \mathbf{\hat{y}}_{u} = \bm{\Sigma}_{u, s} \bm{\Sigma}_{s, s}^{-1}(\mathbf{y}_s - \bm{\hat{\mu}}_s) + \bm{\hat{\mu}}_{u}, -->
<!-- \end{equation} -->
 
However, we often are not interested in predicting total abundance across multiple years and instead would want a prediction of the total abundance in the most recent year of the survey. Then, $\mathbf{b}_a$ should not be a vector of 1's and should instead take a value of 1 if the observation is in the current year of the survey and a 0 if the observation is not in the current year of the survey:
\mbox{}
\begin{equation}
\mathbf{b}_a = [\mathbf{b}_{up}^\prime, \mathbf{b}_{uc}', \mathbf{b}_{sp}', , \mathbf{b}_{sc}']' = [\mathbf{0}', \mathbf{1}', \mathbf{0}', \mathbf{1}']',
\end{equation}
\noindent
where the subscripts $up$, $uc$, $sp$, and $sc$ denote unsampled sites in past years, unsampled sites in current years, sampled sites in past years, and sampled sites in current years, respectively.

$\bm{\lambda}_s$ can then be rewritten as
\mbox{}
\begin{equation}
\bm{\lambda}_s = \mathbf{b}_{s}' + \mathbf{b}_{uc}' (\bm{\Sigma}_{uc, s}\bm{\Sigma}_{s, s}^{-1}) - \mathbf{b}'_{uc}(\bm{\Sigma}_{uc, s} \bm{\Sigma}_{s, s}^{-1})\mathbf{X}_s(\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1} + \mathbf{b}_{uc}' \mathbf{X}_{uc}'(\mathbf{X}_s'\bm{\Sigma}_{s, s}^{-1}\mathbf{X}_s)^{-1}\mathbf{X}_s \bm{\Sigma}_{s, s}^{-1}.
\end{equation}

with a prediction variance of
\mbox{}
\begin{equation}
\bm{\lambda}_s'\bm{\Sigma}_{s, s}\bm{\lambda}_s - 2 \mathbf{b}_{c}' \bm{\Sigma}_{c, s} \bm{\lambda}_s + \mathbf{b}_{c}' \bm{\Sigma}_{c, c} \mathbf{b}_{c},
\end{equation}
\noindent
where $c$ denotes observations in the current year.

\section{Application} \label{section:Application}

<!-- Other Information: 2013: separate area -->
<!-- 2016: no snow -->

<!-- -2013: two regions surveyed -->
<!-- 2014- pare it down to the smaller area from the larger area previously -->
<!-- 2019- took two areas from 2004 - 2014 plus what was added on after 2014 -->
<!-- 2020- 2014-2018 -->
<!-- 2021- 2014-2018 area (planned) -->

 <!-- From 2004 - 2012, two regions were surveyed on an alternating year basis (e.g. Region 1 was surveyed in 2004, Region 2 in 2005, Region 1 in 2006, etc.). In 2013, both of these regions were surveyed. From 2014 - 2018, the the two "alternating year regions" were combined into one single survey region that was a subset of these two regions. This smaller region was thought to be of the highest importance for moose abundance prediction. The 2014 - 2018 region also included a small region that was not part of the 2004 - 2013 surveys. 2016 did not have a survey because there was not sufficient snow cover. The 2019 survey took the survey area from 2004 - 2013 and added the small region that was added in the 2014 - 2018 surveys. 2020 reverted to the 2014 - 2018 survey area, and 2021 is planned to also survey that same area.  -->

<!-- In summary, there is a subset of sites that was sampled from 2004 - 2020, but, of most interest is probably the area that has been surveyed every year since 2014 (except for the year 2016, when no survey was done). -->

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(here)
library(FPSpatioTemp)
# moose_temp_high <- read_csv(here("inst",
#                                  "datasets/moose_high_2014_2018.csv"))
data(moose_14_20)

## use most recent stratification
moose_14_20 <- moose_14_20 %>%
  mutate(newstrat = if_else(Surveyyear == 2020,
                            true = stratfact, 
                            false = NA_integer_)) %>%
  group_by(ID) %>% fill(newstrat, .direction = "updown")

moose_temp_high <- moose_14_20 %>% dplyr::filter(newstrat == "HIGH")

## keep only variables that are necessary for analysis
moose_df_high <- moose_temp_high %>%
  select(totalmoosena, SurveyID, Surveyyear, ID,
         newstrat, xcoords, ycoords, samp_frame)

## create a variable for what values we want added up for
## abundance
moose_df_high <- moose_df_high %>%
  mutate(yearind = if_else(Surveyyear == 2020 & samp_frame == 1, true = 1, false = 0)) %>% ungroup()

moose_df_merge <- moose_df_high %>% filter(yearind == 1) %>% select(ID)
moose_final_high <- semi_join(moose_df_high, moose_df_merge)

## n unique spatial points and n unique time points.
nspat <- nrow(moose_final_high) / length(unique(moose_final_high$Surveyyear))
ntime <- nrow(moose_final_high) / nrow(unique(cbind(moose_final_high$xcoords, moose_final_high$ycoords)))
```

```{r}
moose_temp_low <- moose_14_20 %>% dplyr::filter(newstrat == "LOW")

## keep only variables that are necessary for analysis
moose_df_low <- moose_temp_low %>%
  select(totalmoosena, SurveyID, Surveyyear, ID,
         newstrat, xcoords, ycoords, samp_frame)

## create a variable for what values we want added up for
## abundance
moose_df_low <- moose_df_low %>%
  mutate(yearind = if_else(Surveyyear == 2020 & samp_frame == 1, true = 1, false = 0)) %>% ungroup()

moose_df_merge_low <- moose_df_low %>% filter(yearind == 1) %>% select(ID)
moose_final_low <- semi_join(moose_df_low, moose_df_merge_low)

## n unique spatial points and n unique time points.
nspat_low <- nrow(moose_final_low) / length(unique(moose_final_low$Surveyyear))
ntime_low <- nrow(moose_final_low) / nrow(unique(cbind(moose_final_low$xcoords, moose_final_low$ycoords)))
```


Abundance surveys are performed in the TOK region of Alaska annually. In particular, surveys were conducted every year from 2014 through 2020, except for the year 2016, during which there was not sufficient snow cover to perform a survey. Before each survey, the sites are stratified into a High stratum and a Low stratum. In the high stratum, there are 230 unique spatial locations in the sampling frame of each year while in the low stratum, there are 151 unique spatial locations. For both strata, there are 7 unique time points, including the year 2016. 

```{r, cache = TRUE}
fit_obj_high <- stlmfit(formula = totalmoosena ~ 1,
                        data = moose_final_high,
                        xcoordcol = "xcoords",
                        ycoordcol = "ycoords",
                        tcol = "Surveyyear")
```

```{r, results = "hide"}
pred_obj_high <- predict(object = fit_obj_high,
                         wtscol = "yearind")

prediction_high <- pred_obj_high$totalpred
predvar_high <- pred_obj_high$predvar
lb_high <- pred_obj_high$lb
ub_high <- pred_obj_high$ub
tab_stlmfit_high <- cbind(prediction_high, sqrt(predvar_high),
                          lb_high, ub_high)
library(xtable)
xtable(tab_stlmfit_high, digits = 0)
```

```{r, cache = TRUE}
fit_obj_low <- stlmfit(formula = totalmoosena ~ 1,
                       data = moose_final_low,
                       xcoordcol = "xcoords",
                       ycoordcol = "ycoords",
                       tcol = "Surveyyear")
```

```{r, results = "hide"}
pred_obj_low <- predict(object = fit_obj_low, wtscol = "yearind")

prediction_low <- pred_obj_low$totalpred
predvar_low <- pred_obj_low$predvar
lb_low <- pred_obj_low$lb
ub_low <- pred_obj_low$ub
tab_stlmfit_low <- cbind(prediction_low, sqrt(predvar_low),
                          lb_low, ub_low)
xtable(tab_stlmfit_low, digits = 0)
```

```{r, results = "hide"}
unlist(fit_obj_high$parms)
unlist(fit_obj_low$parms)
```

```{r, fig.keep = "none"}
plot_sp(fit_obj_high$data$xcoords, fit_obj_high$data$ycoords,
        fit_obj_high$data$Surveyyear, fit_obj_high$data$totalmoosena)
plot_sp(fit_obj_low$data$xcoords, fit_obj_low$data$ycoords,
        fit_obj_low$data$Surveyyear, fit_obj_low$data$totalmoosena)
plot_t(fit_obj_high$data$xcoords, fit_obj_high$data$ycoords,
        fit_obj_high$data$Surveyyear, fit_obj_high$data$totalmoosena)
plot_t(fit_obj_low$data$xcoords, fit_obj_low$data$ycoords,
        fit_obj_low$data$Surveyyear, fit_obj_low$data$totalmoosena)
```

```{r}
pred_total <- tab_stlmfit_low[1, 1] + tab_stlmfit_high[1, 1]
pred_var <- sqrt(tab_stlmfit_low[1, 2] ^ 2 +
                   tab_stlmfit_high[1, 2] ^ 2)
pis <- pred_total + c(-1, 1) * 1.96 * 65.415
```

The strata are fit separately with a sum-with-error covariance, an exponential spatial correlation structure, and an AR(1) temporal correlation structure outlined in \ref{section:Methods}. The predicted total abundance is `r round(pred_total, 0)` moose with a 95% prediction interval of (`r round(pis[1], 0)`, `r round(pis[2], 0)`) moose.

```{r, results = "hide"}
## sptotal on HIGH stratum
moose_final_high_2020 <- moose_final_high %>%
  dplyr::filter(Surveyyear == 2020)

library(sptotal)
fit_obj_2020_high <- slmfit(formula = totalmoosena ~ 1,
                       data = moose_final_high_2020,
                       xcoordcol = "xcoords", ycoordcol = "ycoords",
                       estmethod = "ML")
pred_obj_2020_high <- predict(fit_obj_2020_high)
tab_sptotal_high <- cbind(pred_obj_2020_high$FPBK_Prediction, sqrt(pred_obj_2020_high$PredVar),
                     pred_obj_2020_high$conf_bounds[1], pred_obj_2020_high$conf_bounds[2])
tab_combined_high <- rbind(tab_stlmfit_high, tab_sptotal_high)
row.names(tab_combined_high) <- c("stlmfit", "sptotal")
colnames(tab_combined_high) <- c("prediction", "se", "90% lb", "90% ub")

## sptotal on LOW stratum
moose_final_low_2020 <- moose_final_low %>%
  dplyr::filter(Surveyyear == 2020)

library(sptotal)
fit_obj_2020_low <- slmfit(formula = totalmoosena ~ 1,
                       data = moose_final_low_2020,
                       xcoordcol = "xcoords", ycoordcol = "ycoords",
                       estmethod = "ML")

pred_obj_2020_low <- predict(fit_obj_2020_low)
tab_sptotal_low <- cbind(pred_obj_2020_low$FPBK_Prediction, sqrt(pred_obj_2020_low$PredVar),
                     pred_obj_2020_low$conf_bounds[1], pred_obj_2020_low$conf_bounds[2])
tab_combined_low <- rbind(tab_stlmfit_low, tab_sptotal_low)
row.names(tab_combined_low) <- c("stlmfit", "sptotal")
colnames(tab_combined_low) <- c("prediction", "se", "90% lb", "90% ub")


pred_sptotal <- pred_obj_2020_high$FPBK_Prediction + pred_obj_2020_low$FPBK_Prediction
se_sptotal <- sqrt(pred_obj_2020_high$PredVar + pred_obj_2020_low$PredVar)
pis_sptotal <- pred_sptotal[1, 1] +
  c(-1, 1) * 1.96 * se_sptotal[1, 1]
```

Moose surveys in the TOC region were historically analyzed without explicitly using any data from surveys in past years. Therefore, we compare the spatiotemporal prediction and prediction interval with a spatial model fit with the $\texttt{sptotal}$ package using only the data from the year 2020. The prediction total abundance is `r round(pred_sptotal, 0)` moose with a 95% prediction interval of (`r round(pis_sptotal[1], 0)`, `r round(pis_sptotal[2], 0)`) moose. We see that the predictions are somewhat similar, but that, because the strictly spatial analysis ignores information from past years, the prediction interval for the spatiotemporal analysis is more narrow.

\section{Simulation} \label{section:Simulation}

* possibly include `sptotal` (on current year only) and SRS (on current year only) as reference comparisons.

For a preliminary simulation, we use a grid of 100 spatial sites and 5 time points. The spatiotemporal process is simulated as a sum-with-error model with an exponential spatial correlation structure and an exponential temporal correlation structure with the following parameters

The mean is

* $\beta$ = 10.

The spatial parameters are

* $\sigma^2_{\delta}$ = 0.9, 
* $\sigma^2_{\gamma}$ = 0.1,
* $\phi$ = 5.

The temporal parameters are

* $\sigma^2_{\tau}$ = 0.7, 
* $\sigma^2_{\eta}$ = 0.3,
* $\rho$ = 0.8.

And, the spatiotemporal nugget is

* $\sigma^2_{\nu}$ = 0.4.

The sample size $n$ is 100 (of the 500 total data points). For 100 iterations, the percentage of 90% prediction intervals that covered the true total was 81%. 

There are a few plausible reasons for this low coverage:

* there is something incorrect about the method or code used.
* the sample size is only 100 sites, meaning that, on average, only 20 sites get selected per year. This small sample size may mean that the 8 parameters cannot be estimated accurately. I believe that this is the actual cause of the lower than nominal coverage and hope to do a larger simulation study next.
* only 100 simulations were done.

Hampering investigation of this is the fact that the simulations take a long time to run. The `stmodel` package will be very helpful for this, as we can replace the slow code for fitting the spatiotemporal model with faster code from the package.

```{r, echo = FALSE, results = "hide"}
library(here)
sim_res <- read_csv(here("inst", "simulations", "sim_output.csv"))

sim_res %>% summarise(coverage = mean(conf_ind),
                            rmspe = sqrt(sum((pred - truetotal) ^ 2)),
                            medci = median(ub - lb),
                            meanse = mean(se))
```

\section{Discussion} \label{section:Discussion}

* mention substantial reduction of se in the application (and, presumably, the simulations).

* mention normal-based-related limitations

* mention Bayesian approach, and its potential flaws

* mention possible extension to imperfect detection

* mention forecasting potential

* take-home message: monitoring programs that use regularly surveys might consider incorporating time into their analysis to improve precision of predictors (e.g. NARS for lake assessments).


